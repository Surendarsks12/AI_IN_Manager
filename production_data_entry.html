<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Production Log Sheet</title>
  <style>
    /* (same styles as before, trimmed here for brevity) */
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid black; padding: 8px; text-align: center; }
    input, select { width: 100%; box-sizing: border-box; }
    .top-info, .range-entry { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    button:hover { background-color: #45a049; }
  </style>
</head>
<body>

<h2>Production Log Sheet</h2>

<div class="top-info">
  <label>Shift Date: <input type="date" id="shiftDate"></label>
  <label>Shift Start Time: <input type="time" id="shiftStart"></label>
  <label>Shift End Time: <input type="time" id="shiftEnd"></label>
  <label>Machine Name: <input type="text" id="machineName" placeholder="e.g., T-1"></label>
  <button onclick="generateRows()">Generate Sheet</button>
</div>

<h3>Fill Operation & Drawing for Slot Range</h3>
<div class="range-entry">
  <label>From Slot #: <input type="number" id="slotStart" min="1"></label>
  <label>To Slot #: <input type="number" id="slotEnd" min="1"></label>
  <label>Drawing No.: <input type="text" id="rangeDrawing"></label>
  <label>Operation: <input type="text" id="rangeOperation"></label>
  <button onclick="fillRowsBySlot()">Apply to Slot Range</button>
</div>

<table id="logTable">
  <thead>
    <tr>
      <th>Slot No.</th><th>Time In</th><th>Time Out</th><th>Drawing No.</th><th>Operation</th>
      <th>Setting Time (mins)</th><th>Idle Time (mins)</th><th>Working Time (hrs)</th>
      <th>Processed Qty</th><th>Remarks</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="submitToSheet()">Submit to Google Sheet</button>

<script>
function formatTime(date) {
  const hours = String(date.getHours()).padStart(2, '0');
  const mins = String(date.getMinutes()).padStart(2, '0');
  return `${hours}:${mins}`;
}

function generateRows() {
  const start = document.getElementById("shiftStart").value;
  const end = document.getElementById("shiftEnd").value;
  const tbody = document.querySelector("#logTable tbody");
  tbody.innerHTML = "";

  if (!start || !end) {
    alert("Please enter shift times.");
    return;
  }

  let startTime = new Date(`1970-01-01T${start}:00`);
  let endTime = new Date(`1970-01-01T${end}:00`);
  if (endTime <= startTime) endTime.setDate(endTime.getDate() + 1);

  let currentTime = new Date(startTime);
  let slot = 1;

  while (currentTime < endTime) {
    const nextTime = new Date(currentTime.getTime() + 3600000);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input value="${slot}" readonly></td>
      <td><input type="time" value="${formatTime(currentTime)}" readonly></td>
      <td><input type="time" value="${formatTime(nextTime)}" readonly></td>
      <td><input type="text"></td>
      <td><input type="text"></td>
      <td><input type="number" min="0" onchange="calcWorking(this)"></td>
      <td><input type="number" min="0" onchange="calcWorking(this)"></td>
      <td><input type="text" readonly></td>
      <td><input type="number"></td>
      <td><input type="text"></td>
    `;
    tbody.appendChild(row);
    currentTime = nextTime;
    slot++;
  }
}

function calcWorking(el) {
  const row = el.closest("tr");
  const setting = parseFloat(row.children[5].children[0].value) || 0;
  const idle = parseFloat(row.children[6].children[0].value) || 0;
  const working = 1 - ((setting + idle) / 60);
  row.children[7].children[0].value = working > 0 ? working.toFixed(2) : 0;
}

function fillRowsBySlot() {
  const from = parseInt(document.getElementById("slotStart").value);
  const to = parseInt(document.getElementById("slotEnd").value);
  const drawing = document.getElementById("rangeDrawing").value;
  const op = document.getElementById("rangeOperation").value;
  const rows = document.querySelectorAll("#logTable tbody tr");

  rows.forEach((row, i) => {
    const slot = i + 1;
    if (slot >= from && slot <= to) {
      row.children[3].children[0].value = drawing;
      row.children[4].children[0].value = op;
    }
  });
}

function submitToSheet() {
  const shiftDate = document.getElementById("shiftDate").value;
  const machineName = document.getElementById("machineName").value;
  const rows = document.querySelectorAll("#logTable tbody tr");

  if (!shiftDate || !machineName) {
    alert("Shift Date and Machine Name are required.");
    return;
  }

  const data = {
    shiftDate,
    machineName,
    rows: Array.from(rows).map(row => ({
      slot: row.children[0].children[0].value,
      timeIn: row.children[1].children[0].value,
      timeOut: row.children[2].children[0].value,
      drawingNo: row.children[3].children[0].value,
      operation: row.children[4].children[0].value,
      settingTime: row.children[5].children[0].value,
      idleTime: row.children[6].children[0].value,
      workingTime: row.children[7].children[0].value,
      processedQty: row.children[8].children[0].value,
      remarks: row.children[9].children[0].value
    }))
  };

  fetch('https://script.google.com/macros/s/AKfycbzWsmBt6XzJmEaQR9Hye0GgiSV-GgJt2e1lWBaFpbehZcG4JaP6jFMHskNNwCFPgAkotA/exec', {
    method: 'POST',
    body: JSON.stringify(data),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.text())
  .then(msg => {
    alert("Submitted Successfully!");
  })
  .catch(err => {
    alert("Failed to submit: " + err.message);
  });
}
</script>
</body>
</html>
