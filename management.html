<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manager Panel - Product Entry</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background: #87f0d1; }
    table { margin:20px auto; border-collapse: collapse; width: 90%; }
    th, td { border:1px solid #ccc; padding:10px; }
    th { background:#555; color:white; }
    input, select { width:95%; padding:6px; box-sizing:border-box; }
    .component-name { font-weight:bold; color:green; }
    .component-name.error { color:red; }
    button { padding:10px 20px; margin-top:20px; background:#0032ad; color:white; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Product Allocation Desk</h1>

  <label>Start Date:</label><br>
  <input type="date" id="start-date" required><br><br>

  <table id="product-table">
    <thead>
      <tr>
        <th>Component Code</th>
        <th>Component Name</th>
        <th>Quantity</th>
        <th>Delivery Date</th>
      </tr>
    </thead>
    <tbody>
      <!-- Initial row -->
      <tr>
        <td>
          <select onchange="onComponentChange(this)">
            <option value="">-- Select --</option>
          </select>
        </td>
        <td><span class="component-name"></span></td>
        <td><input type="number" min="1" placeholder="Qty" disabled required></td>
        <td><input type="date" disabled required></td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">➕ Add Another Product</button>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPgtjHjEB6kEsdSE4bn4BfMalnp9f1RIcQQd8Mc-JGeVNBNaG6bAE3n98QXFqKZZvlGw/exec"; // Replace with your script's URL

    // Populate all dropdowns on load
    window.onload = populateDropdowns;
    fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(data => {
    const select = newRow.querySelector("select");
    data.forEach(([id, name]) => {
      const option = document.createElement("option");
      option.value = id;
      option.textContent = `${id} — ${name}`;
      select.appendChild(option);
    });
  });
        })
        .catch(err => console.error("Error loading dropdown:", err));
    }

    function onComponentChange(select) {
      const code = select.value;
      const row = select.closest("tr");
      const nameSpan = row.querySelector(".component-name");
      const qty = row.cells[2].querySelector("input");
      const date = row.cells[3].querySelector("input");

      if (!code) return;

      fetch(`${SCRIPT_URL}?code=${code}`)
        .then(res => res.text())
        .then(name => {
          if (name === "INVALID") {
            nameSpan.textContent = "❌ Invalid ID";
            nameSpan.className = "component-name error";
            qty.disabled = date.disabled = true;
          } else {
            nameSpan.textContent = name;
            nameSpan.className = "component-name";
            qty.disabled = date.disabled = false;
          }
        })
        .catch(err => {
          console.error("Error fetching name:", err);
          nameSpan.textContent = "⚠️ Error fetching";
          nameSpan.className = "component-name error";
          qty.disabled = date.disabled = true;
        });
    }

    function addRow() {
      const tbody = document.getElementById("product-table").querySelector("tbody");
      const newRow = tbody.insertRow();
      newRow.innerHTML = `
        <td>
          <select onchange="onComponentChange(this)">
            <option value="">-- Select --</option>
          </select>
        </td>
        <td><span class="component-name"></span></td>
        <td><input type="number" min="1" placeholder="Qty" disabled required></td>
        <td><input type="date" disabled required></td>
      `;
      populateDropdowns(); // refill options
    }
  </script>
</body>
</html>

