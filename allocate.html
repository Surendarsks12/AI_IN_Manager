<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manual Allocation</title>
  <style>
    body { font-family: 'Times New Roman'; padding: 20px; background-color: #FFFBE6; }
    .machine-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .machine-btn { padding: 10px; background-color: #3399FF; color: white; border: none; border-radius: 8px; cursor: pointer; width: 120px; }
    .modal {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border: 2px solid #333; z-index: 10;
    }
    .overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5); display: none; z-index: 9;
    }
    select, input { width: 100%; margin-top: 5px; margin-bottom: 10px; padding: 5px; }
  </style>
</head>
<body>

<h2>Allocate Work to Machines</h2>
<div id="layoutInfo"></div>
<div class="machine-grid" id="machineGrid"></div>

<div class="overlay" id="overlay" onclick="closeDialog()"></div>
<div class="modal" id="modal">
  <h3 id="modalTitle"></h3>
  <label>Component: <select id="componentSelect"></select></label>
  <label>Operation: <input type="number" id="operationInput" min="1" /></label>
  <label>Quantity: <input type="number" id="quantityInput" /></label>
  <label>Setting Time (min): <input type="number" id="settingInput" /></label>
  <label>Idle Time (min): <input type="number" id="idleInput" /></label>
  <p id="result"></p>
  <button onclick="allocate()">Allocate</button>
</div>

<script>
let cycleData = {};
let currentMachine = '';
let layout = {};

fetch("https://script.google.com/macros/s/AKfycbzRAMYIy9L2nzYgy_1qSSYWFctszMdRE2JqIytU_jQ8xCJZzNTrD7NccQN4eKNYAw72/exec")
  .then(res => res.json())
  .then(data => { cycleData = data; initLayout(); });

function initLayout() {
  layout = JSON.parse(localStorage.getItem('layoutData'));
  if (!layout) return alert("No layout found. Please setup layout first.");

  document.getElementById('layoutInfo').innerHTML = `
    <p><strong>Weekdays:</strong> ${layout.weekdays.join(', ')}</p>
    <p><strong>Shift:</strong> ${layout.shiftHours} hrs (${layout.shiftTimings})</p>
  `;

  const grid = document.getElementById('machineGrid');
  layout.machines.forEach(name => {
    const btn = document.createElement('button');
    btn.textContent = name;
    btn.className = 'machine-btn';
    btn.onclick = () => openDialog(name);
    grid.appendChild(btn);
  });

  const sel = document.getElementById('componentSelect');
  for (let key in cycleData) {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = key;
    sel.appendChild(opt);
  }
}

function openDialog(machineName) {
  currentMachine = machineName;
  document.getElementById('modalTitle').textContent = "Allocate for " + machineName;
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('modal').style.display = 'block';
}

function closeDialog() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('modal').style.display = 'none';
}

function allocate() {
  const comp = document.getElementById('componentSelect').value;
  const qty = +document.getElementById('quantityInput').value;
  const op = document.getElementById('operationInput').value;
  const setting = +document.getElementById('settingInput').value;
  const idle = +document.getElementById('idleInput').value;

  const key = comp.toLowerCase() + "_" + op;
  const cycleTime = +cycleData[key];
  const totalOpTime = qty * cycleTime;

  const resultText = `
    <strong>Result:</strong><br>
    Qty: ${qty}, Cycle Time: ${cycleTime} min<br>
    <strong>Total Operation Time:</strong> ${totalOpTime} min
  `;
  document.getElementById('result').innerHTML = resultText;

  // âœ¨ Here you can add the saving logic (Google Sheets API call)
}
</script>

</body>
</html>
