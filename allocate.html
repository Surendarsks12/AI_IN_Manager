<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manual Allocation</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .machine-btn { margin: 5px; padding: 10px; background: #007bff; color: white; cursor: pointer; }
  </style>
</head>
<body>

<h2>Allocate Work to Machines</h2>
<div id="info"></div>
<div id="machines"></div>

<div id="dialog" style="display:none; border:1px solid #000; padding:20px; background:#eee; margin-top:20px;">
  <h3 id="assignTitle">Assign</h3>
  <label>Component: 
    <select id="componentSelect"></select>
  </label><br>
  <label>Quantity: <input id="qty" type="number"></label><br>
  <label>Setting Time (min): <input id="setting" type="number"></label><br>
  <label>Idle Time (min): <input id="idle" type="number"></label><br>
  <button onclick="submitAllocation()">Submit</button>
</div>

<br><br>
<button onclick="clearData()">üßπ Clear All Data</button>

<script>
  let cycleMap = {};
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzh0m2bz6dbnA74O28Wb4zrhIXjCvyMpCyRgKIxLZNKczJwJnDzrwPXhinTpCb3lpli/exec";

  fetch(SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
      cycleMap = data.cycleMap;
      populateLayout();
    });

  function populateLayout() {
    const layout = JSON.parse(localStorage.getItem("layout"));
    if (!layout) return alert("Layout not found.");

    document.getElementById("info").innerText = `Weekdays: ${layout.days.join(", ")} | Shift: ${layout.shiftHours} hrs`;

    const machineDiv = document.getElementById("machines");
    machineDiv.innerHTML = "";
    for (let i = 1; i <= layout.machineCount; i++) {
      const btn = document.createElement("button");
      btn.className = "machine-btn";
      btn.innerText = `t${i}`;
      btn.onclick = () => openDialog(`t${i}`);
      machineDiv.appendChild(btn);
    }

    const select = document.getElementById("componentSelect");
    select.innerHTML = "";
    Object.keys(cycleMap).forEach(k => {
      const opt = document.createElement("option");
      opt.value = k;
      opt.innerText = k;
      select.appendChild(opt);
    });
  }

  let currentMachine = "";

  function openDialog(machine) {
    currentMachine = machine;
    document.getElementById("assignTitle").innerText = `Allocate for ${machine}`;
    document.getElementById("dialog").style.display = "block";
  }

  function submitAllocation() {
    const component = document.getElementById("componentSelect").value;
    const qty = +document.getElementById("qty").value;
    const setting = +document.getElementById("setting").value;
    const idle = +document.getElementById("idle").value;
    const cycle = +cycleMap[component];
    const total = qty * cycle;

    const layout = JSON.parse(localStorage.getItem("layout"));
    const payload = {
      allocations: [{
        day: layout.days[0], // pick first selected day for now
        machine: currentMachine,
        shift: 1,
        component,
        qty,
        setting,
        idle,
        total
      }]
    };

    fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    }).then(res => res.text()).then(alert);
  }

  function clearData() {
    const code = prompt("Enter secret code to clear all:");
    if (code === "secret@123") {
      fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ clear: code })
      }).then(res => res.text()).then(alert);
    } else {
      alert("‚ùå Invalid code.");
    }
  }
</script>
</body>
</html>
